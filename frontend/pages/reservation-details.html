<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Details - TinyHouse</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .reservation-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .reservation-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .reservation-status {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }

        .status-pending { background: rgba(251, 191, 36, 0.3); color: #fbbf24; border: 2px solid #fbbf24; }
        .status-confirmed { background: rgba(34, 197, 94, 0.3); color: #22c55e; border: 2px solid #22c55e; }
        .status-completed { background: rgba(59, 130, 246, 0.3); color: #3b82f6; border: 2px solid #3b82f6; }
        .status-cancelled { background: rgba(239, 68, 68, 0.3); color: #ef4444; border: 2px solid #ef4444; }

        .reservation-id {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .reservation-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .reservation-dates {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .reservation-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .detail-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .property-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: 200px 200px;
            gap: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .gallery-main {
            grid-row: span 2;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-info {
            margin-bottom: 1.5rem;
        }

        .property-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .property-location {
            color: #666;
            margin-bottom: 1rem;
        }

        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .detail-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #666;
        }

        .guest-info, .host-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .person-details h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
        }

        .person-details p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .pricing-breakdown {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .price-row.total {
            font-weight: 600;
            font-size: 1.1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            color: #111827;
        }

        .payment-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .payment-success {
            color: #065f46;
            font-weight: 500;
        }

        .payment-pending {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #e5e7eb;
            color: #374151;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .timeline-icon.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .timeline-content h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
        }

        .timeline-content p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .contact-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .error-state {
            text-align: center;
            padding: 3rem;
            color: #ef4444;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .reservation-content {
                grid-template-columns: 1fr;
            }
            
            .property-gallery {
                grid-template-columns: 1fr;
                grid-template-rows: 200px repeat(4, 120px);
            }
            
            .gallery-main {
                grid-row: 1;
            }
            
            .property-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .reservation-container {
                padding: 0 1rem;
            }
            
            .reservation-header {
                padding: 2rem 1rem;
            }
            
            .reservation-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h2>üè† TinyHouse</h2>
            </div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <a href="properties.html">Properties</a>
                <a href="#" id="dashboardLink">Dashboard</a>
                <a href="#" onclick="logout()" class="btn-secondary">Logout</a>
            </div>
        </div>
    </nav>

    <div class="reservation-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <h3>Loading reservation details...</h3>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error-state" style="display: none;">
            <h3>üö´ Reservation Not Found</h3>
            <p>The reservation you're looking for doesn't exist or you don't have permission to view it.</p>
            <a href="../index.html" class="btn btn-primary">Back to Home</a>
        </div>

        <!-- Reservation Content -->
        <div id="reservationContent" style="display: none;">
            <!-- Reservation Header -->
            <div class="reservation-header">
                <div class="reservation-id" id="reservationId">Reservation #12345</div>
                <div class="reservation-status" id="reservationStatus">confirmed</div>
                <h1 class="reservation-title" id="propertyTitle">Loading...</h1>
                <div class="reservation-dates" id="reservationDates">
                    üìÖ Loading dates...
                </div>
                <div class="reservation-dates" id="guestInfo">
                    üë• Loading guest info...
                </div>
            </div>

            <!-- Reservation Content Grid -->
            <div class="reservation-content">
                <div class="main-content">
                    <!-- Property Details -->
                    <div class="detail-card">
                        <h2 class="card-title">
                            üè† Property Details
                        </h2>
                        
                        <div class="property-gallery" id="propertyGallery">
                            <div class="gallery-item gallery-main">
                                <img id="mainImage" src="https://images.unsplash.com/photo-1464207687429-7505649dae38?w=600" alt="Property">
                            </div>
                            <div class="gallery-item">
                                <img src="https://images.unsplash.com/photo-1520637736862-4d197d17c726?w=300" alt="Property">
                            </div>
                            <div class="gallery-item">
                                <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300" alt="Property">
                            </div>
                            <div class="gallery-item">
                                <img src="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300" alt="Property">
                            </div>
                            <div class="gallery-item">
                                <img src="https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=300" alt="Property">
                            </div>
                        </div>

                        <div class="property-info">
                            <h3 class="property-title" id="propertyName">Property Name</h3>
                            <p class="property-location" id="propertyLocation">üìç Location</p>
                            
                            <div class="property-details">
                                <div class="detail-item">
                                    <span class="detail-icon">üë•</span>
                                    <strong id="maxGuests">4</strong>
                                    <div class="detail-label">Max Guests</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üõèÔ∏è</span>
                                    <strong id="bedrooms">2</strong>
                                    <div class="detail-label">Bedrooms</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üöø</span>
                                    <strong id="bathrooms">1</strong>
                                    <div class="detail-label">Bathrooms</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üåô</span>
                                    <strong id="totalNights">3</strong>
                                    <div class="detail-label">Nights</div>
                                </div>
                            </div>
                        </div>

                        <a href="#" id="viewPropertyLink" class="btn btn-outline">
                            View Full Property Details
                        </a>
                    </div>

                    <!-- Host Information -->
                    <div class="detail-card">
                        <h2 class="card-title">
                            üë§ Your Host
                        </h2>
                        
                        <div class="host-info">
                            <div class="avatar" id="hostAvatar">H</div>
                            <div class="person-details">
                                <h4 id="hostName">Host Name</h4>
                                <p id="hostEmail">host@example.com</p>
                                <p id="hostPhone">+90 555 123 4567</p>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-outline contact-button" onclick="contactHost()">
                                üìû Contact Host
                            </button>
                        </div>
                    </div>

                    <!-- Reservation Timeline -->
                    <div class="detail-card">
                        <h2 class="card-title">
                            üìã Reservation Timeline
                        </h2>
                        
                        <div id="reservationTimeline">
                            <!-- Timeline items will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <!-- Pricing Summary -->
                    <div class="detail-card">
                        <h2 class="card-title">
                            üí∞ Pricing Summary
                        </h2>
                        
                        <div class="pricing-breakdown">
                            <div class="price-row">
                                <span>‚Ç∫<span id="pricePerNight">150</span> x <span id="nightCount">3</span> nights</span>
                                <span>‚Ç∫<span id="subtotal">450</span></span>
                            </div>
                            <div class="price-row" id="cleaningFeeRow" style="display: none;">
                                <span>Cleaning fee</span>
                                <span>‚Ç∫<span id="cleaningFee">0</span></span>
                            </div>
                            <div class="price-row total">
                                <span>Total</span>
                                <span>‚Ç∫<span id="totalAmount">450</span></span>
                            </div>
                        </div>

                        <div id="paymentInfo" class="payment-info">
                            <div class="payment-success">
                                ‚úÖ Payment completed
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="detail-card">
                        <h2 class="card-title">
                            ‚ö° Actions
                        </h2>
                        
                        <div class="action-buttons" id="actionButtons">
                            <!-- Action buttons will be populated based on status -->
                        </div>

                        <div id="actionMessage" class="message"></div>
                    </div>

                    <!-- Guest Information (for hosts) -->
                    <div class="detail-card" id="guestCard" style="display: none;">
                        <h2 class="card-title">
                            üë§ Guest Information
                        </h2>
                        
                        <div class="guest-info">
                            <div class="avatar" id="guestAvatar">G</div>
                            <div class="person-details">
                                <h4 id="guestName">Guest Name</h4>
                                <p id="guestEmail">guest@example.com</p>
                                <p id="guestPhone">+90 555 987 6543</p>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-outline contact-button" onclick="contactGuest()">
                                üìû Contact Guest
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script>
        let currentReservation = null;
        let currentUser = null;
        const token = localStorage.getItem('token');
        const reservationId = new URLSearchParams(window.location.search).get('id');

        // Check authentication
        if (!token) {
            alert('Please login first');
            window.location.href = 'login.html';
        }

        // Get current user
        try {
            currentUser = JSON.parse(localStorage.getItem('user'));
            if (currentUser && currentUser.role) {
                document.getElementById('dashboardLink').href = `${currentUser.role}/dashboard_${currentUser.role}.html`;
            }
        } catch (e) {
            console.error('Error parsing user data:', e);
        }

        if (!reservationId) {
            showError('No reservation ID provided');
        } else {
            loadReservationDetails();
        }

        // Load reservation details
        async function loadReservationDetails() {
            try {
                const response = await API.getReservation(reservationId);
                currentReservation = response.reservation;
                displayReservationDetails();
                
            } catch (error) {
                console.error('Error loading reservation:', error);
                showError(error.message || 'Failed to load reservation details');
            }
        }

        // Display reservation details
        function displayReservationDetails() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('reservationContent').style.display = 'block';

            const reservation = currentReservation;

            // Header information
            document.getElementById('reservationId').textContent = `Reservation #${reservation.reservation_id}`;
            document.getElementById('reservationStatus').textContent = reservation.reservation_status;
            document.getElementById('reservationStatus').className = `reservation-status status-${reservation.reservation_status}`;
            document.getElementById('propertyTitle').textContent = reservation.property_title || 'Property';
            
            // Dates
            const checkIn = API.formatDate(reservation.check_in_date);
            const checkOut = API.formatDate(reservation.check_out_date);
            document.getElementById('reservationDates').textContent = `üìÖ ${checkIn} - ${checkOut}`;
            document.getElementById('guestInfo').textContent = `üë• ${reservation.guest_count} guests ‚Ä¢ ${reservation.total_nights} nights`;

            // Property details
            document.getElementById('propertyName').textContent = reservation.property_title;
            document.getElementById('propertyLocation').textContent = `üìç ${reservation.city}, ${reservation.address || ''}`;
            document.getElementById('maxGuests').textContent = reservation.max_guests || '4';
            document.getElementById('bedrooms').textContent = reservation.bedrooms || '2';
            document.getElementById('bathrooms').textContent = reservation.bathrooms || '1';
            document.getElementById('totalNights').textContent = reservation.total_nights;
            
            // Property link
            document.getElementById('viewPropertyLink').href = `property-details.html?id=${reservation.property_id}`;

            // Host information
            const hostName = `${reservation.owner_first_name} ${reservation.owner_last_name}`;
            document.getElementById('hostName').textContent = hostName;
            document.getElementById('hostEmail').textContent = reservation.owner_email || '';
            document.getElementById('hostPhone').textContent = reservation.owner_phone || '';
            document.getElementById('hostAvatar').textContent = reservation.owner_first_name?.charAt(0).toUpperCase() || 'H';

            // Show guest information if user is the host
            if (currentUser && currentUser.role === 'owner') {
                const guestCard = document.getElementById('guestCard');
                guestCard.style.display = 'block';
                
                const guestName = `${reservation.tenant_first_name} ${reservation.tenant_last_name}`;
                document.getElementById('guestName').textContent = guestName;
                document.getElementById('guestEmail').textContent = reservation.tenant_email || '';
                document.getElementById('guestPhone').textContent = reservation.tenant_phone || '';
                document.getElementById('guestAvatar').textContent = reservation.tenant_first_name?.charAt(0).toUpperCase() || 'G';
            }

            // Pricing
            document.getElementById('pricePerNight').textContent = reservation.price_per_night;
            document.getElementById('nightCount').textContent = reservation.total_nights;
            
            const subtotal = reservation.price_per_night * reservation.total_nights;
            document.getElementById('subtotal').textContent = subtotal;
            
            if (reservation.cleaning_fee && reservation.cleaning_fee > 0) {
                document.getElementById('cleaningFee').textContent = reservation.cleaning_fee;
                document.getElementById('cleaningFeeRow').style.display = 'flex';
            }
            
            document.getElementById('totalAmount').textContent = reservation.total_amount;

            // Payment status
            updatePaymentStatus();

            // Property images
            if (reservation.property_images && reservation.property_images.length > 0) {
                updatePropertyImages(reservation.property_images);
            }

            // Timeline and actions
            updateTimeline();
            updateActionButtons();
        }

        // Update payment status
        function updatePaymentStatus() {
            const paymentInfo = document.getElementById('paymentInfo');
            
            if (currentReservation.payment_status === 'completed') {
                paymentInfo.className = 'payment-info';
                paymentInfo.innerHTML = `
                    <div class="payment-success">
                        ‚úÖ Payment completed on ${API.formatDate(currentReservation.payment_date)}
                        ${currentReservation.transaction_id ? `<br>Transaction ID: ${currentReservation.transaction_id}` : ''}
                    </div>
                `;
            } else {
                paymentInfo.className = 'payment-info payment-pending';
                paymentInfo.innerHTML = `
                    <div class="payment-pending">
                        ‚è≥ Payment pending
                    </div>
                `;
            }
        }

        // Update property images
        function updatePropertyImages(images) {
            const mainImage = document.getElementById('mainImage');
            const primaryImage = images.find(img => img.is_primary) || images[0];
            
            if (primaryImage) {
                mainImage.src = `http://localhost:3001${primaryImage.image_url}`;
            }
        }

        // Update timeline
        function updateTimeline() {
            const timeline = document.getElementById('reservationTimeline');
            const status = currentReservation.reservation_status;
            const bookingDate = API.formatDate(currentReservation.booking_date);
            
            const timelineItems = [
                {
                    icon: 'üìÖ',
                    title: 'Reservation Created',
                    description: `Booking made on ${bookingDate}`,
                    completed: true
                },
                {
                    icon: '‚úÖ',
                    title: 'Reservation Confirmed',
                    description: status === 'confirmed' || status === 'completed' ? 'Host confirmed your booking' : 'Waiting for host confirmation',
                    completed: status === 'confirmed' || status === 'completed'
                },
                {
                    icon: 'üí≥',
                    title: 'Payment',
                    description: currentReservation.payment_status === 'completed' ? 'Payment completed' : 'Payment pending',
                    completed: currentReservation.payment_status === 'completed'
                },
                {
                    icon: 'üè†',
                    title: 'Check-in',
                    description: `${API.formatDate(currentReservation.check_in_date)}`,
                    completed: status === 'completed'
                },
                {
                    icon: 'üéâ',
                    title: 'Trip Completed',
                    description: status === 'completed' ? 'Trip completed successfully' : 'Enjoy your stay!',
                    completed: status === 'completed'
                }
            ];

            if (status === 'cancelled') {
                timelineItems.push({
                    icon: '‚ùå',
                    title: 'Reservation Cancelled',
                    description: currentReservation.cancellation_reason || 'Reservation was cancelled',
                    completed: true
                });
            }

            timeline.innerHTML = timelineItems.map(item => `
                <div class="timeline-item">
                    <div class="timeline-icon ${item.completed ? 'completed' : ''}">
                        ${item.icon}
                    </div>
                    <div class="timeline-content">
                        <h4>${item.title}</h4>
                        <p>${item.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // Update action buttons
        function updateActionButtons() {
            const actionButtons = document.getElementById('actionButtons');
            const status = currentReservation.reservation_status;
            const userRole = currentUser?.role;
            let buttons = [];

            // Tenant actions
            if (userRole === 'tenant') {
                if (status === 'pending') {
                    buttons.push({
                        text: 'Cancel Reservation',
                        class: 'btn-danger',
                        action: 'cancelReservation'
                    });
                }
                
                if (status === 'confirmed' && currentReservation.payment_status !== 'completed') {
                    buttons.push({
                        text: 'Make Payment',
                        class: 'btn-primary',
                        action: 'makePayment'
                    });
                }
                
                if (status === 'completed') {
                    buttons.push({
                        text: 'Write Review',
                        class: 'btn-success',
                        action: 'writeReview'
                    });
                }
            }

            // Owner actions
            if (userRole === 'owner') {
                if (status === 'pending') {
                    buttons.push({
                        text: 'Confirm Reservation',
                        class: 'btn-success',
                        action: 'confirmReservation'
                    });
                    buttons.push({
                        text: 'Decline Reservation',
                        class: 'btn-danger',
                        action: 'declineReservation'
                    });
                }
                
                if (status === 'confirmed') {
                    buttons.push({
                        text: 'Mark as Completed',
                        class: 'btn-primary',
                        action: 'completeReservation'
                    });
                }
            }

            // Common actions
            buttons.push({
                text: 'Download Receipt',
                class: 'btn-outline',
                action: 'downloadReceipt'
            });

            actionButtons.innerHTML = buttons.map(btn => `
                <button class="btn ${btn.class}" onclick="${btn.action}()">
                    ${btn.text}
                </button>
            `).join('');
        }

        // Action handlers
        async function cancelReservation() {
            if (!confirm('Are you sure you want to cancel this reservation?')) return;
            
            const reason = prompt('Please provide a reason for cancellation (optional):') || 'Cancelled by guest';
            
            try {
                await API.updateReservationStatus(reservationId, 'cancelled', reason);
                showMessage('Reservation cancelled successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Failed to cancel reservation:', error);
                showMessage('Failed to cancel reservation: ' + error.message, 'error');
            }
        }

        async function confirmReservation() {
            if (!confirm('Confirm this reservation?')) return;
            
            try {
                await API.updateReservationStatus(reservationId, 'confirmed');
                showMessage('Reservation confirmed successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Failed to confirm reservation:', error);
                showMessage('Failed to confirm reservation: ' + error.message, 'error');
            }
        }

        async function declineReservation() {
            if (!confirm('Are you sure you want to decline this reservation?')) return;
            
            const reason = prompt('Please provide a reason for declining:') || 'Declined by host';
            
            try {
                await API.updateReservationStatus(reservationId, 'cancelled', reason);
                showMessage('Reservation declined', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Failed to decline reservation:', error);
                showMessage('Failed to decline reservation: ' + error.message, 'error');
            }
        }

        async function completeReservation() {
            if (!confirm('Mark this reservation as completed?')) return;
            
            try {
                await API.updateReservationStatus(reservationId, 'completed');
                showMessage('Reservation marked as completed', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Failed to complete reservation:', error);
                showMessage('Failed to complete reservation: ' + error.message, 'error');
            }
        }

        async function makePayment() {
            try {
                const paymentMethods = {
                    '1': 'credit_card',
                    '2': 'bank_transfer', 
                    '3': 'paypal'
                };
                
                const choice = prompt(`Select payment method:\n1. Credit Card\n2. Bank Transfer\n3. PayPal\n\nEnter 1, 2, or 3:`);
                
                if (!paymentMethods[choice]) {
                    showMessage('Invalid payment method selected', 'error');
                    return;
                }

                await API.createPayment({
                    reservationId: parseInt(reservationId),
                    paymentMethod: paymentMethods[choice]
                });
                
                showMessage('Payment processed successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Payment failed:', error);
                showMessage('Payment failed: ' + error.message, 'error');
            }
        }

        function writeReview() {
            window.location.href = `write-review.html?reservationId=${reservationId}&propertyId=${currentReservation.property_id}`;
        }

        function downloadReceipt() {
            // Generate a simple receipt
            const receiptContent = generateReceiptHTML();
            
            // Create and download receipt
            const blob = new Blob([receiptContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TinyHouse-Receipt-${reservationId}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showMessage('Receipt downloaded successfully', 'success');
        }

        function generateReceiptHTML() {
            const reservation = currentReservation;
            const checkIn = API.formatDate(reservation.check_in_date);
            const checkOut = API.formatDate(reservation.check_out_date);
            const bookingDate = API.formatDate(reservation.booking_date);
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>TinyHouse Receipt - ${reservationId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
                        .logo { font-size: 2rem; color: #3b82f6; margin-bottom: 10px; }
                        .receipt-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .section { margin-bottom: 20px; }
                        .section h3 { border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .total { font-weight: bold; font-size: 1.2rem; border-top: 2px solid #333; padding-top: 10px; }
                        .status { padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
                        .status-confirmed { background: #d1fae5; color: #065f46; }
                        .status-completed { background: #dbeafe; color: #1e40af; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 0.9rem; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">üè† TinyHouse</div>
                        <h2>Reservation Receipt</h2>
                        <div>Receipt #${reservationId} | ${bookingDate}</div>
                    </div>
                    
                    <div class="receipt-info">
                        <div class="row">
                            <span>Reservation ID:</span>
                            <span>#${reservation.reservation_id}</span>
                        </div>
                        <div class="row">
                            <span>Status:</span>
                            <span class="status status-${reservation.reservation_status}">${reservation.reservation_status.toUpperCase()}</span>
                        </div>
                        <div class="row">
                            <span>Booking Date:</span>
                            <span>${bookingDate}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Property Details</h3>
                        <div class="row">
                            <span>Property:</span>
                            <span>${reservation.property_title}</span>
                        </div>
                        <div class="row">
                            <span>Location:</span>
                            <span>${reservation.city}, ${reservation.address || ''}</span>
                        </div>
                        <div class="row">
                            <span>Host:</span>
                            <span>${reservation.owner_first_name} ${reservation.owner_last_name}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Stay Details</h3>
                        <div class="row">
                            <span>Check-in:</span>
                            <span>${checkIn}</span>
                        </div>
                        <div class="row">
                            <span>Check-out:</span>
                            <span>${checkOut}</span>
                        </div>
                        <div class="row">
                            <span>Guests:</span>
                            <span>${reservation.guest_count} guests</span>
                        </div>
                        <div class="row">
                            <span>Nights:</span>
                            <span>${reservation.total_nights} nights</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Pricing Breakdown</h3>
                        <div class="row">
                            <span>‚Ç∫${reservation.price_per_night} x ${reservation.total_nights} nights</span>
                            <span>‚Ç∫${reservation.price_per_night * reservation.total_nights}</span>
                        </div>
                        ${reservation.cleaning_fee > 0 ? `
                        <div class="row">
                            <span>Cleaning fee</span>
                            <span>‚Ç∫${reservation.cleaning_fee}</span>
                        </div>
                        ` : ''}
                        <div class="row total">
                            <span>Total</span>
                            <span>‚Ç∫${reservation.total_amount}</span>
                        </div>
                    </div>
                    
                    ${reservation.payment_status === 'completed' ? `
                    <div class="section">
                        <h3>Payment Information</h3>
                        <div class="row">
                            <span>Payment Status:</span>
                            <span>Completed</span>
                        </div>
                        <div class="row">
                            <span>Payment Date:</span>
                            <span>${API.formatDate(reservation.payment_date)}</span>
                        </div>
                        ${reservation.transaction_id ? `
                        <div class="row">
                            <span>Transaction ID:</span>
                            <span>${reservation.transaction_id}</span>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p>Thank you for choosing TinyHouse!</p>
                        <p>For support, contact us at support@tinyhouse.com</p>
                    </div>
                </body>
                </html>
            `;
        }

        function contactHost() {
            const hostEmail = currentReservation.owner_email;
            const hostPhone = currentReservation.owner_phone;
            
            const contact = prompt(`Contact ${currentReservation.owner_first_name}:\n\n1. Email: ${hostEmail}\n2. Phone: ${hostPhone}\n\nEnter 1 for email or 2 for phone:`);
            
            if (contact === '1' && hostEmail) {
                window.location.href = `mailto:${hostEmail}?subject=Regarding Reservation #${reservationId}`;
            } else if (contact === '2' && hostPhone) {
                window.location.href = `tel:${hostPhone}`;
            }
        }

        function contactGuest() {
            const guestEmail = currentReservation.tenant_email;
            const guestPhone = currentReservation.tenant_phone;
            
            const contact = prompt(`Contact ${currentReservation.tenant_first_name}:\n\n1. Email: ${guestEmail}\n2. Phone: ${guestPhone}\n\nEnter 1 for email or 2 for phone:`);
            
            if (contact === '1' && guestEmail) {
                window.location.href = `mailto:${guestEmail}?subject=Regarding Reservation #${reservationId}`;
            } else if (contact === '2' && guestPhone) {
                window.location.href = `tel:${guestPhone}`;
            }
        }

        // Utility functions
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            
            const errorText = document.querySelector('#errorState p');
            if (errorText) {
                errorText.textContent = message;
            }
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('actionMessage');
            messageEl.textContent = message;
            messageEl.className = 'message ' + (type === 'success' ? 'success-message' : 'error-message');
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        function logout() {
            API.logout();
            window.location.href = 'login.html';
        }

        // Initialize page
        console.log('üè† Reservation Details page initialized');
    </script>
</body>
</html>